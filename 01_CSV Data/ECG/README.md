# راهنمای گام‌به‌گام: تحلیل و پردازش سیگنال ECG با پایتون



<img src="Infographic_Raw ECG to Heart Rate Workflow.png" alt="Infographic_Raw ECG to Heart Rate Workflow" style="zoom: 33%;" />



## 1. مقدمه: هدف و کاربرد کد

این کد یک چارچوب عملی و بنیادی برای تحلیل سیگنال ECG ارائه می‌دهد. هدف ما در این راهنما، نه تنها تشریح عملکرد کد `ecg_teaching_script.py`، بلکه ارائه بینشی عمیق در مورد "چرایی" هر یک از مراحل است تا بتوانید این پایه را برای تحلیل‌های پیچیده‌تر توسعه دهید. این فرآیند از بارگذاری داده‌های خام آغاز شده، مراحل پیش‌پردازش و پاک‌سازی سیگنال را طی می‌کند و در نهایت به استخراج ویژگی‌های کلیدی مانند مکان‌یابی کمپلکس QRS و تخمین ضربان قلب (Heart Rate) ختم می‌شود. این راهنما برای دانشجویانی که دارای دانش پایه‌ای در زمینه برنامه‌نویسی یا پردازش سیگنال هستند، تهیه شده است. برای شروع، اجازه دهید نگاهی کلی به کل فرآیند بیندازیم.

## 2. نمای کلی فرآیند: از داده خام تا نتیجه نهایی

داشتن یک دید کلی از کل خط لوله پردازش، به درک بهتر نقش و اهمیت هر مرحله کمک شایانی می‌کند. این کد یک رویکرد سیستماتیک را دنبال می‌کند که در آن خروجی هر مرحله، ورودی مرحله بعدی را تشکیل می‌دهد. جریان کاری کلی را می‌توان در چهار مرحله اصلی خلاصه کرد:

1. **پیکربندی و بارگذاری داده:** در این مرحله اولیه، پارامترهای اساسی مانند فرکانس نمونه‌برداری تعریف شده و فایل‌های داده ECG از فرمت CSV خوانده می‌شوند.
2. **پیش‌پردازش سیگنال:** سیگنال خام بارگذاری شده، از طریق فیلترسازی و نرمال‌سازی، از نویز پاک‌سازی شده و برای تحلیل‌های بعدی استانداردسازی می‌شود.
3. **تشخیص کمپلکس QRS:** در قلب این فرآیند، الگوریتمی برای شناسایی دقیق پیک‌های R (که بخش اصلی کمپلکس QRS هستند) بر روی سیگنال پاک‌سازی شده اجرا می‌شود.
4. **تحلیل و تولید خروجی:** در مرحله نهایی، بر اساس مکان پیک‌های شناسایی‌شده، معیارهای کلینیکی مانند ضربان قلب محاسبه شده و نتایج نهایی (شامل سیگنال پردازش‌شده و مکان پیک‌ها) در فایل‌های جداگانه ذخیره می‌شوند.

در ادامه، به بررسی دقیق جزئیات مرحله اول، یعنی پیکربندی و بارگذاری داده‌ها، می‌پردازیم.

## 3. مرحله ۱: پیکربندی و بارگذاری داده‌ها

مرحله پیکربندی و بارگذاری داده‌ها، پایه‌ای است که کل فرآیند تحلیل بر روی آن بنا می‌شود. تعریف صحیح پارامترها در این بخش، تضمین‌کننده صحت محاسبات در مراحل بعدی است. پارامترهای اصلی در بخش `Config` کد تعریف شده‌اند.

|   پارامتر    |                                                توضیح و اهمیت |
| :----------: | -----------------------------------------------------------: |
|     `FS`     | این متغیر، **فرکانس نمونه‌برداری** سیگنال را `400.0Hz` تعیین می‌کند. این مقدار به این معناست که در هر ثانیه، ۴۰۰ نقطه داده از سیگنال ثبت شده است. این پارامتر نه تنها برای محاسبات زمانی عمومی، بلکه مستقیماً در مرحله تشخیص پیک QRS برای تبدیل یک مقدار فیزیولوژیکی (حداقل فاصله زمانی بین دو ضربان) به یک پارامتر پردازشی (حداقل فاصله بر حسب نمونه) استفاده می‌شود. |
| `FILE_PATHS` | این متغیر یک لیست از مسیر فایل‌های ورودی است. در این کد، سه فایل `ecg_sample_1.csv`, `ecg_sample_2.csv` و `ecg_sample_3.csv` برای پردازش مشخص شده‌اند. |
| `LEAD_NAME`  | این متغیر، نام ستونی را در فایل CSV مشخص می‌کند که حاوی داده‌های ولتاژ سیگنال ECG است (مثلاً `"lead_1"`). این امر به کد اجازه می‌دهد تا لید مورد نظر را برای تحلیل استخراج کند. |

پس از تعریف این پارامترها، تابع `load_ecg_csv` با استفاده از کتابخانه قدرتمند `pandas`، هر فایل CSV را خوانده و داده‌ها را در یک ساختار داده مناسب (DataFrame) بارگذاری می‌کند. با بارگذاری موفقیت‌آمیز داده‌ها، مرحله بعدی آماده‌سازی آن‌ها برای تحلیل است.

## 4. مرحله ۲: پیش‌پردازش سیگنال - آماده‌سازی داده برای تحلیل

سیگنال‌های ECG خام به ندرت ایده‌آل هستند و اغلب حاوی نویز و آرتیفکت‌های ناخواسته‌ای هستند که می‌توانند دقت تحلیل را به شدت کاهش دهند. برای مثال، حرکت بیمار یا تنفس می‌تواند باعث انحراف خط پایه (baseline wander) شود و فعالیت‌های عضلانی نیز نویز فرکانس بالا ایجاد می‌کند. هدف از مرحله پیش‌پردازش، حذف این اختلالات و استانداردسازی سیگنال برای دستیابی به نتایج قابل اعتماد است.

### 4.1. فیلتر میان‌گذر (Bandpass Filtering)

اولین گام در پاک‌سازی سیگنال، استفاده از یک فیلتر میان‌گذر است که توسط توابع `butter_bandpass` و `bandpass_filter` پیاده‌سازی می‌شود. این فیلتر به گونه‌ای طراحی شده است که تنها فرکانس‌های بین `0.5` **تا** `40.0` **هرتز** را از خود عبور دهد. این محدوده در متون علمی به طور گسترده‌ای پذیرفته شده است، زیرا بخش اصلی انرژی سیگنال مربوط به کمپلکس QRS را حفظ کرده و در عین حال به طور مؤثری منابع نویز رایج را حذف می‌کند:

- **حد پایین (0.5Hz):** فرکانس‌های پایین‌تر از این حد، که معمولاً مربوط به نویز انحراف خط پایه هستند، حذف می‌شوند.
- **حد بالا (40.0Hz):** فرکانس‌های بالاتر از این حد، که اغلب ناشی از آرتیفکت‌های عضلانی و نویز خط برق هستند، فیلتر می‌شوند.

### 4.2. نرمال‌سازی Z-Score

پس از فیلترسازی، دامنه سیگنال ممکن است در فایل‌های مختلف متغیر باشد. تابع `normalize_signal` با استفاده از نرمال‌سازی Z-score، **میانگین سیگنال را به صفر** و **انحراف معیار آن را به یک** تنظیم می‌کند. این استانداردسازی تضمین می‌کند که آستانه تشخیص پیک (`height`) که به صورت درصدی از بیشینه دامنه تعریف شده، نسبت به ویژگی‌های آماری خود سیگنال عمل کند و نه یک مقدار ولتاژ مطلق. این امر الگوریتم را در برابر تغییرات دامنه سیگنال بین بیماران یا لیدهای مختلف، مقاوم می‌سازد.

اکنون که سیگنال تمیز و استاندارد شده است، آماده مرحله اصلی تحلیل یعنی تشخیص QRS است.

## 5. مرحله ۳: تحلیل اصلی - تشخیص پیک QRS

تشخیص کمپلکس QRS، به ویژه پیک R آن، مهم‌ترین بخش تحلیل سیگنال ECG است. این کمپلکس نماینده دپلاریزاسیون بطن‌های قلب است و شناسایی دقیق آن اساس محاسبه ضربان قلب را تشکیل می‌دهد. در این کد، این وظیفه بر عهده تابع `detect_qrs` است که از تابع `find_peaks` از کتابخانه `scipy` بهره می‌برد.

برای اطمینان از تشخیص صحیح، دو پارامتر کلیدی برای تابع `find_peaks` با دقت تنظیم شده‌اند:

- **`height`**: این پارامتر حداقل دامنه لازم برای یک نقطه را تعیین می‌کند تا به عنوان "پیک" در نظر گرفته شود. در این کد، مقدار آن برابر با `0.5 * np.max(ecg)` تنظیم شده است. این بدان معناست که تنها پیک‌هایی به عنوان کاندیدای پیک R شناسایی می‌شوند که دامنه آن‌ها **حداقل ۵۰٪ بیشینه دامنه سیگنال پردازش‌شده** باشد. این رویکرد دینامیک (آستانه نسبی) به مراتب از یک آستانه ثابت و مطلق (مثلاً height=1.0) کارآمدتر است، زیرا با تغییرات دامنه سیگنال که امری رایج است، خود را تطبیق می‌دهد.
- **`distance`**: این پارامتر حداقل فاصله افقی (بر حسب تعداد نمونه) بین دو پیک متوالی را مشخص می‌کند. این پارامتر یک نمونه عالی از ترجمه یک دانش فیزیولوژیک (اینکه ضربان قلب انسان به ندرت از ۲۰۰ تپش در دقیقه فراتر می‌رود، معادل فاصله ۰.۳ ثانیه) به یک پارامتر مهندسی در دامنه دیجیتال است. مقدار آن با ضرب حداقل فاصله زمانی (`min_rr_sec = 0.3`) در فرکانس نمونه‌برداری (`FS`) محاسبه می‌شود. با این کار، از شناسایی اشتباه امواج دیگر مانند موج T به عنوان یک کمپلکس QRS جدید جلوگیری می‌کنیم.

پس از شناسایی دقیق پیک‌ها با این روش، می‌توانیم معیارهای معناداری مانند ضربان قلب را استخراج کرده و نتایج را ذخیره کنیم.

## 6. مرحله ۴: استخراج نتایج و تولید خروجی‌ها

این مرحله نهایی، نتایج تحلیل‌های انجام‌شده را به خروجی‌های ملموس و قابل استفاده تبدیل می‌کند. این خروجی‌ها شامل یک معیار کلینیکی مهم (ضربان قلب) و فایل‌های داده‌ای برای تحلیل‌های بیشتر یا مستندسازی هستند.

### 6.1. تخمین ضربان قلب

تابع `estimate_heart_rate` مسئولیت محاسبه ضربان قلب را بر عهده دارد. این فرآیند به شرح زیر است:

1. ابتدا فواصل زمانی بین هر دو پیک R متوالی (که به عنوان **فواصل RR** شناخته می‌شوند) بر حسب ثانیه محاسبه می‌شود.
2. سپس، از این فواصل میانگین گرفته می‌شود تا یک فاصله RR متوسط به دست آید.
3. در نهایت، با تقسیم عدد `60.0` بر این میانگین، ضربان قلب بر حسب **"تپش در دقیقه" (BPM)** تخمین زده می‌شود.

### 6.2. ذخیره‌سازی داده‌های پردازش‌شده و نتایج

برای هر فایل ورودی، کد دو فایل خروجی مجزا با فرمت CSV ایجاد می‌کند تا نتایج به صورت دائمی ذخیره شوند:

- `**ecg_sample_{idx}_processed.csv**`: این فایل حاوی سیگنال ECG پس از اعمال فیلتر میان‌گذر و نرمال‌سازی است. ستون‌های آن شامل `time_s` (زمان بر حسب ثانیه) و `ecg_processed` (مقدار سیگنال پردازش‌شده) است. این فایل برای بصری‌سازی یا تحلیل‌های بیشتر بسیار مفید است.
- `**ecg_sample_{idx}_qrs.csv**`: این فایل مکان دقیق پیک‌های R شناسایی‌شده را ذخیره می‌کند. ستون‌های آن شامل `peak_index` (اندیس نمونه‌ای که پیک در آن رخ داده) و `peak_time_s` (زمان دقیق وقوع پیک بر حسب ثانیه) است.

برای اطمینان از صحت عملکرد تمام مراحل، بصری‌سازی نتایج نقشی کلیدی ایفا می‌کند.

## 7. بصری‌سازی: تأیید صحت فرآیند

بصری‌سازی یک ابزار حیاتی در هر خط لوله پردازش سیگنال است، زیرا به ما امکان می‌دهد تا به صورت شهودی نتایج هر مرحله را درک کرده و صحت عملکرد الگوریتم‌ها را تأیید کنیم. این کد از دو تابع رسم نمودار برای این منظور استفاده می‌کند:

- **`plot_raw_vs_processed`**: این تابع سیگنال خام را در کنار سیگنال پردازش‌شده نمایش می‌دهد. این مقایسه به شما اجازه می‌دهد تا تأثیر فیلتر را به وضوح مشاهده کنید. به طور مشخص، به حذف انحرافات آرام خط پایه (baseline wander) در نمودار پایینی و همچنین کاهش نویزهای فرکانس بالا توجه کنید.
- **`plot_with_qrs`**: این تابع، سیگنال پردازش‌شده را رسم کرده و مکان پیک‌های R شناسایی‌شده را با نشانگرهای دایره‌ای (`"o"`) بر روی آن مشخص می‌کند. این نمودار را برای ارزیابی سریع نتایج به کار ببرید. به دنبال دو نوع خطا باشید: مثبت کاذب (نشانگر روی پیکی که QRS نیست) و منفی کاذب (یک کمپلکس QRS واضح که هیچ نشانگری ندارد).

این راهنما یک مرور جامع بر خط لوله پردازش ECG ارائه داد.

## 8. جمع‌بندی

در این راهنما، یک خط لوله کامل برای تحلیل و پردازش سیگنال ECG را به صورت گام‌به‌گام بررسی کردیم. این فرآیند شامل چهار مرحله کلیدی بود: پیکربندی و بارگذاری داده، پیش‌پردازش برای حذف نویز، تشخیص پیک‌های QRS، و در نهایت استخراج ضربان قلب و ذخیره‌سازی نتایج. این کد نه تنها یک ابزار آموزشی مؤثر است، بلکه به عنوان یک چارچوب پایه عمل می‌کند. این چارچوب می‌تواند نقطه شروعی برای تحلیل‌های پیشرفته‌تر باشد، مانند محاسبه معیارهای تغییرپذیری ضربان قلب (HRV) از روی فواصل RR استخراج‌شده، یا افزودن ماژول‌هایی برای تشخیص آریتمی‌های خاص با تحلیل مورفولوژی موج ECG.